<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>منظم المهام الذكي للطلاب</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Tajawal',sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:100vh;
  padding:20px;
}
h1{
  font-size:2em;
  margin-bottom:20px;
  color:#ffcc00;
  text-align:center;
}
.container{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:20px;
  width:100%;
  max-width:1200px;
}
.channel{
  background:#1c1c1c;
  border-radius:12px;
  padding:10px;
  width:280px;
  min-height:200px;
  display:flex;
  flex-direction:column;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
  position:relative;
}
.channel-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.channel-header h2{
  font-size:1.2em;
  color:#fff;
  word-break:break-word;
}
.channel-header button{
  background:none;
  border:none;
  color:#f44336;
  font-size:1.2em;
  cursor:pointer;
  transition:transform 0.2s ease;
}
.channel-header button:hover{
  transform:scale(1.2);
}
.channel ul{
  list-style:none;
  flex-grow:1;
  padding:0;
  margin:0;
}
.channel li{
  background:#222;
  border-radius:8px;
  margin-bottom:8px;
  padding:8px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:grab;
}
.channel li:active{
  cursor:grabbing;
}
.task-text{
  flex-grow:1;
  margin-right:10px;
  overflow-wrap:break-word;
}
.task-buttons{
  display:flex;
  align-items:center;
  gap:5px;
}
.task-buttons button{
  background:none;
  border:none;
  color:#fff;
  font-size:1em;
  cursor:pointer;
  transition:transform 0.2s ease;
}
.task-buttons button:hover{
  transform:scale(1.2);
}
.checked .task-text{
  text-decoration:line-through;
  color:#aaa;
}
.add-task{
  display:flex;
  gap:5px;
  margin-top:10px;
}
.add-task input{
  flex-grow:1;
  padding:6px;
  border-radius:6px;
  border:none;
  outline:none;
  background:#333;
  color:#fff;
}
.add-task button{
  background:#ffcc00;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  color:#000;
}
.add-channel{
  margin-top:20px;
  display:flex;
  gap:8px;
  width:100%;
  max-width:400px;
}
.add-channel input{
  flex-grow:1;
  padding:8px;
  border-radius:6px;
  border:none;
  outline:none;
  background:#333;
  color:#fff;
}
.add-channel button{
  background:#ffcc00;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  color:#000;
}
footer{
  margin-top:40px;
  color:#666;
  font-size:0.9em;
  text-align:center;
}

/* drag visual */
.dragging{
  opacity:0.5;
}

/* Mobile-specific styles */
@media (max-width: 768px) {
  .channel-header button.delete-channel {
    color: #ff0000 !important;
    font-weight: bold;
  }
}
</style>
</head>
<body>
<h1>منظم المهام الذكي للطلاب</h1>
<div class="container" id="channelsContainer"></div>

<div class="add-channel">
  <input type="text" id="newChannelInput" placeholder="اسم القناة الجديدة" />
  <button id="addChannelBtn">إضافة قناة</button>
</div>

<footer>
  <p>من صنع الطالب • جميع الحقوق محفوظة © 2025</p>
</footer>

<script>
/* ---------------- Core Data ---------------- */
let stored = JSON.parse(localStorage.getItem("tasksDataV2")) || { order: [], channels: {} };

function saveData(){
  localStorage.setItem("tasksDataV2", JSON.stringify(stored));
}

/* ---------------- Check if Mobile ---------------- */
const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ---------------- Rendering ---------------- */
function htmlSafeId(str){return str.replace(/[^a-z0-9_-]/gi,'_');}

function render(){
  const container = document.getElementById("channelsContainer");
  container.innerHTML = "";
  
  // Create default channel for mobile if it doesn't exist
  if (isMobile && !stored.channels["المهام"]) {
    stored.channels["المهام"] = [];
    if (!stored.order.includes("المهام")) {
      stored.order.unshift("المهام");
    }
  }
  
  stored.order.forEach(ch=>{
    const ulId = `ul-${htmlSafeId(ch)}`;
    const channelDiv = document.createElement("div");
    channelDiv.className = "channel";
    channelDiv.innerHTML = `
      <div class="channel-header">
        <h2 class="channel-name">${ch}</h2>
        <div>
          <button class="delete-channel" title="حذف القناة">✖</button>
        </div>
      </div>
      <ul id="${ulId}" ondragover="event.preventDefault()" ondrop="onDrop(event,'${ch}')"></ul>
      <div class="add-task">
        <input type="text" placeholder="مهمة جديدة..." onkeydown="if(event.key==='Enter') addTask('${ch}', this)" />
        <button onclick="addTask('${ch}', this.previousElementSibling)">+</button>
      </div>
    `;
    container.appendChild(channelDiv);
    const ul = document.getElementById(ulId);
    stored.channels[ch].forEach(task=>{
      const li = document.createElement("li");
      li.draggable = true;
      li.ondragstart = (ev)=>onDrag(ev, ch, task.text);
      li.innerHTML = `
        <span class="task-text">${task.text}</span>
        <div class="task-buttons">
          <button class="check-btn" onclick="toggleCheck('${ch}', '${task.text}')">${task.checked?'☑':'☐'}</button>
          <button onclick="editTaskPrompt('${ch}', '${task.text}')">✎</button>
          <button onclick="deleteTask('${ch}', '${task.text}')">✖</button>
        </div>
      `;
      if(task.checked) li.classList.add("checked");
      ul.appendChild(li);
    });
  });
  
  // Make delete buttons red on mobile
  if (isMobile) {
    document.querySelectorAll('.delete-channel').forEach(btn => {
      btn.style.color = '#ff0000';
    });
  }
}

/* ---------------- Channels & Tasks Logic ---------------- */
function addChannel(){
  const input=document.getElementById("newChannelInput");
  const name=input.value.trim();
  if(!name||stored.channels[name])return;
  stored.channels[name]=[];
  stored.order.push(name);
  saveData();render();
  input.value="";
}

document.getElementById("addChannelBtn").onclick=addChannel;

function addTask(channel,input){
  const text=input.value.trim();
  if(!text)return;
  
  // On mobile, if no channel is specified, add to default channel
  if (isMobile && !channel) {
    channel = "المهام";
    if (!stored.channels[channel]) {
      stored.channels[channel] = [];
      if (!stored.order.includes(channel)) {
        stored.order.unshift(channel);
      }
    }
  }
  
  stored.channels[channel].push({text,checked:false});
  saveData();render();
  input.value="";
}

function deleteChannel(name){
  if(!confirm(`هل أنت متأكد من حذف القناة "${name}"؟`))return;
  delete stored.channels[name];
  stored.order=stored.order.filter(c=>c!==name);
  saveData();render();
}

function deleteTask(channel,text){
  stored.channels[channel]=stored.channels[channel].filter(t=>t.text!==text);
  saveData();render();
}

function toggleCheck(channel,text){
  const t=stored.channels[channel].find(x=>x.text===text);
  if(!t)return;
  t.checked=!t.checked;
  saveData();render();
}

function editTaskPrompt(channel,text){
  const newText=prompt("تعديل المهمة:",text);
  if(!newText)return;
  const t=stored.channels[channel].find(x=>x.text===text);
  if(!t)return;
  t.text=newText.trim();
  saveData();render();
}

/* ---------------- Drag & Drop (Desktop) ---------------- */
function onDrag(ev,from,text){
  ev.dataTransfer.setData("text/plain",JSON.stringify({from,text}));
}
function onDrop(ev,to){
  ev.preventDefault();
  const data=JSON.parse(ev.dataTransfer.getData("text/plain"));
  if(!data)return;
  const {from,text}=data;
  if(from===to)return;
  const task=stored.channels[from].find(t=>t.text===text);
  if(!task)return;
  stored.channels[from]=stored.channels[from].filter(t=>t.text!==text);
  stored.channels[to].push(task);
  saveData();render();
}

/* ---------------- Event Delegation ---------------- */
document.addEventListener("click",e=>{
  if(e.target.classList.contains("delete-channel")){
    const ch=e.target.closest(".channel").querySelector(".channel-name").textContent;
    deleteChannel(ch);
  }
});

/* ---------------- Touch Drag & Drop (Mobile Only) ---------------- */
(function enableTouchDrag(){
  const isMobileDevice=/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if(!isMobileDevice)return;

  let dragTask=null,dragEl=null;
  let isDragging = false;
  let touchStartTime = 0;
  let touchStartX = 0;
  let touchStartY = 0;
  let dragTimeout = null;

  document.addEventListener("touchstart",e=>{
    const li=e.target.closest("li"); if(!li)return;
    
    // Check if the touch is on a button
    if (e.target.closest('.task-buttons')) {
      return; // Don't start drag if touching buttons
    }
    
    const ul=li.closest("ul"); if(!ul)return;
    const channel=Object.keys(stored.channels).find(k=>`ul-${htmlSafeId(k)}`===ul.id);
    if(!channel)return;
    
    touchStartTime = Date.now();
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    
    // Set a timeout to start dragging after a delay
    dragTimeout = setTimeout(() => {
      const text=li.querySelector(".task-text").textContent;
      dragTask={text,from:channel};
      dragEl=li.cloneNode(true);
      dragEl.style.position="fixed";
      dragEl.style.pointerEvents="none";
      dragEl.style.opacity="0.9";
      dragEl.style.zIndex="9999";
      dragEl.style.transform="scale(1.05)";
      dragEl.style.boxShadow="0 8px 25px rgba(0,0,0,0.5)";
      document.body.appendChild(dragEl);
      const t=e.touches[0];
      dragEl.style.left=t.clientX+"px";
      dragEl.style.top=t.clientY+"px";
      isDragging = true;
    }, 300); // 300ms delay before starting drag
  });

  document.addEventListener("touchmove",e=>{
    if(!isDragging) return;
    
    // Cancel the drag if it's a small movement (likely a tap)
    const touch = e.touches[0];
    const deltaX = Math.abs(touch.clientX - touchStartX);
    const deltaY = Math.abs(touch.clientY - touchStartY);
    
    if (deltaX < 10 && deltaY < 10) return;
    
    if(dragEl){
      const t=e.touches[0];
      dragEl.style.left=(t.clientX-60)+"px";
      dragEl.style.top=(t.clientY-20)+"px";
    }
    e.preventDefault();
  },{passive:false});

  document.addEventListener("touchend",e=>{
    // Clear the drag timeout if it hasn't fired yet
    if (dragTimeout) {
      clearTimeout(dragTimeout);
      dragTimeout = null;
    }
    
    if(!isDragging || !dragEl || !dragTask) {
      isDragging = false;
      return;
    }
    
    const t=e.changedTouches[0];
    const elem=document.elementFromPoint(t.clientX,t.clientY);
    const dropChannelEl=elem?elem.closest(".channel"):null;
    if(dropChannelEl){
      const name=dropChannelEl.querySelector(".channel-name").textContent.trim();
      if(name&&name!==dragTask.from){
        const {from,text}=dragTask;
        const task=stored.channels[from].find(tt=>tt.text===text);
        if(task){
          stored.channels[from]=stored.channels[from].filter(tt=>tt.text!==text);
          stored.channels[name].push(task);
          saveData();render();
        }
      }
    }
    dragEl.remove();
    dragEl=null;
    dragTask=null;
    isDragging = false;
  });
})();

/* ---------------- Initialize ---------------- */
render();
</script>
</body>
</html>
