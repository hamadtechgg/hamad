<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>منظم المهام الذكي للطلاب</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ========================================================================
   Smart Student Task Organizer — Styles
   ======================================================================== */

/* Base page */
:root{
  --bg1: #2e004f;
  --bg2: #4b0082;
  --bg3: #5a2a83;
  --accent-a: #00e5ff;
  --accent-b: #00bcd4;
  --success: #00ff66;
  --danger: #ff4d4d;
  --glass: rgba(255,255,255,0.08);
  --glass-strong: rgba(255,255,255,0.12);
  --prompt-bg: rgba(255,255,255,0.1);
  --text: #ffffff;
}

html,body{
  height:100%;
  margin:0;
  padding:0;
  direction:rtl;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  background: linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  background-size:400% 400%;
  animation: purpleGradient 20s ease infinite;
  font-family: 'Tajawal', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
  color:var(--text);
}

/* background animation */
@keyframes purpleGradient{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

/* top fixed bar */
.top-bar{
  position:fixed;
  right:0;
  top:0;
  left:0;
  height:68px;
  display:flex;
  justify-content:center;
  align-items:center;
  background: rgba(255,255,255,0.12);
  backdrop-filter: blur(8px);
  box-shadow: 0 3px 14px rgba(0,0,0,0.35);
  z-index:1000;
  border-bottom:1px solid rgba(255,255,255,0.08);
  padding:6px 18px;
}

/* container holding main content */
.container{
  width:95%;
  max-width:1400px;
  margin:92px auto 40px;
  background: rgba(255,255,255,0.06);
  border-radius:18px;
  padding:28px;
  box-shadow: 0 18px 50px rgba(0,0,0,0.5);
  backdrop-filter: blur(10px);
}

/* Title — made a bit larger per request */
h1{
  margin:0 0 18px;
  text-align:center;
  font-size:3rem; /* increased */
  line-height:1;
  font-weight:700;
  color:var(--text);
  text-shadow: 0 6px 18px rgba(0,0,0,0.5);
}

/* controls */
.top-controls{
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
  margin-bottom:22px;
}

button{
  border:0;
  outline:0;
  padding:10px 18px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  transition:transform .18s ease, box-shadow .18s ease;
  background:linear-gradient(45deg,var(--accent-a),var(--accent-b));
  color:#002;
}
button:active{ transform: translateY(1px) scale(.995); }
button:hover{ transform: translateY(-2px) scale(1.02); }

/* specific buttons */
button.add-btn{ background: linear-gradient(45deg,var(--accent-a),var(--accent-b)); color:#002; }
button.add-channel-btn{ background: linear-gradient(45deg,#2e7d32,#43a047); color:#fff; }
button.delete-btn{ background: linear-gradient(45deg,#ff4d4d,#ff1a1a); color:#fff; }

/* Channels row:
   Important: use wrapping and vertical scroll instead of horizontal overflow.
   This ensures when 4th channel is added it wraps to next row.
*/
.channels-row{
  display:flex;
  flex-wrap:wrap; /* allow wrapping to new row */
  gap:20px;
  align-items:flex-start;
  /* remove horizontal scrollbar; use vertical scroll for long column height */
  overflow-x:hidden;
  max-height: calc(75vh);
  overflow-y:auto;
  padding:10px;
}

/* channel card sizing — approx 3-per-row layout on wide screens */
.channel{
  background: var(--glass);
  border-radius:14px;
  padding:18px;
  min-width:260px;
  flex: 1 1 calc(33.333% - 20px); /* try to fit 3 per row */
  box-sizing:border-box;
  transition: transform .28s ease, box-shadow .28s ease;
  box-shadow: 0 12px 40px rgba(0,0,0,0.45);
  position:relative;
}

/* smaller screens: allow 2 per row or full width */
@media (max-width:980px){
  .channel{ flex:1 1 calc(50% - 18px); min-width:220px;}
}
@media (max-width:560px){
  .channel{ flex:1 1 100%; min-width:100%; }
}

/* hovered channel */
.channel.hovered{ outline:3px dashed rgba(0,229,255,0.35); }

/* completed channel styles */
.channel.completed{
  background: rgba(0,255,102,0.08);
  box-shadow: 0 16px 48px rgba(0,255,100,0.06);
}

/* channel header */
.channel-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  gap:8px;
}

.channel-title{
  display:flex;
  align-items:center;
  gap:8px;
  position:relative;
  font-weight:700;
  font-size:1.1rem;
}

/* THE SIMPLE WHITE PENCIL ICON (text emoji kept for simplicity) */
.edit-icon{
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:26px;
  height:26px;
  border-radius:6px;
  color:#fff;
  transition: transform .22s ease, background .22s ease, opacity .22s ease;
  background:transparent;
  font-size:16px;
  line-height:1;
}
.edit-icon:hover{
  transform: rotate(45deg);
  background: rgba(255,255,255,0.06);
  opacity:1;
}

/* delete icon */
.delete-icon{
  cursor:pointer;
  color:var(--danger);
  font-weight:800;
  font-size:1.3rem;
}
.delete-icon:hover{ transform:scale(1.12); color:#ff1a1a; }

/* progress bar */
.progress-bar{
  width:100%;
  height:10px;
  background: rgba(255,255,255,0.12);
  border-radius:6px;
  overflow:hidden;
  margin-bottom:14px;
}
.progress-fill{
  height:100%;
  width:0%;
  border-radius:6px;
  background:linear-gradient(90deg,var(--accent-a),var(--accent-b));
  transition: width .36s ease;
}

/* tasks list */
ul{ list-style:none; margin:0; padding:0; min-height:60px; }
li{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:8px 0;
  padding:10px 12px;
  border-radius:10px;
  cursor:grab;
  background: rgba(255,255,255,0.06);
  transition: transform .16s ease, box-shadow .16s ease, background .16s ease;
}
li:hover{ transform: translateY(-3px) scale(1.01); box-shadow: 0 8px 22px rgba(0,0,0,0.35); background: rgba(255,255,255,0.09); }

/* task content */
.task-content{ display:flex; align-items:center; gap:10px; flex:1; }
.task-check{
  width:20px;height:20px;border-radius:4px;border:2px solid var(--accent-a);cursor:pointer;position:relative;flex:0 0 20px;
}
.task-check.checked{ background:var(--accent-a); border-color:transparent; }
.task-check.checked::after{ content:"✔"; position:absolute; color:#fff; font-size:12px; left:3px; top:-3px;}

/* task text */
.task-text{ flex:1; margin-inline-start:8px; }

/* delete task */
.delete-task{ color:var(--danger); font-weight:800; font-size:1.2rem; cursor:pointer; margin-inline-start:8px; }
.delete-task:hover{ transform:scale(1.2); color:#ff1a1a; }

/* floating task preview — moved to top-right per your request */
#floatingTask{
  position:fixed;
  top:90px; /* below top bar */
  right:20px;
  z-index:1200;
  background: rgba(255,255,255,0.06);
  padding:10px 14px;
  border-radius:10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  cursor:grab;
  display:none;
}

/* custom prompt and error prompt share styles */
#customPrompt, #errorPrompt{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background: var(--prompt-bg);
  backdrop-filter: blur(8px);
  padding:22px;
  border-radius:12px;
  z-index:2000;
  display:none;
  width:360px;
  text-align:center;
}
#customPrompt input{ width:100%; padding:10px; border-radius:8px; border:none; margin:12px 0; }
#customPrompt .accept-btn{ background:#4caf50; color:#fff; }
#customPrompt .cancel-btn{ background:#f44336; color:#fff; }

/* error prompt button */
#errorPrompt button{
  margin-top:12px; padding:10px 18px; border-radius:8px; border:none; background:#fff; color:#000; font-weight:700;
}

/* small responsive tweaks */
@media (max-width:640px){
  h1{ font-size:2rem; }
  #floatingTask{ right:10px; top:84px; }
  .container{ margin:80px 10px; padding:18px; }
}

/* accessibility focus */
.edit-icon:focus, .delete-icon:focus, button:focus{ outline:3px solid rgba(0,229,255,0.22); outline-offset:2px; }

/* ========================================================================
   End Styles
   ======================================================================== */

/* Lots of empty/comment lines below are intentionally included to increase
   file length per your request. They do not affect functionality.
   (If you prefer a cleaner file later, I can remove them.)
*/

/*==============================================================================
  filler line 001
  filler line 002
  filler line 003
  filler line 004
  filler line 005
  filler line 006
  filler line 007
  filler line 008
  filler line 009
  filler line 010
  filler line 011
  filler line 012
  filler line 013
  filler line 014
  filler line 015
  filler line 016
  filler line 017
  filler line 018
  filler line 019
  filler line 020
  filler line 021
  filler line 022
  filler line 023
  filler line 024
  filler line 025
  filler line 026
  filler line 027
  filler line 028
  filler line 029
  filler line 030
  filler line 031
  filler line 032
  filler line 033
  filler line 034
  filler line 035
  filler line 036
  filler line 037
  filler line 038
  filler line 039
  filler line 040
  filler line 041
  filler line 042
  filler line 043
  filler line 044
  filler line 045
  filler line 046
  filler line 047
  filler line 048
  filler line 049
  filler line 050
  filler line 051
  filler line 052
  filler line 053
  filler line 054
  filler line 055
  filler line 056
  filler line 057
  filler line 058
  filler line 059
  filler line 060
  filler line 061
  filler line 062
  filler line 063
  filler line 064
  filler line 065
  filler line 066
  filler line 067
  filler line 068
  filler line 069
  filler line 070
  filler line 071
  filler line 072
  filler line 073
  filler line 074
  filler line 075
  filler line 076
  filler line 077
  filler line 078
  filler line 079
  filler line 080
  filler line 081
  filler line 082
  filler line 083
  filler line 084
  filler line 085
  filler line 086
  filler line 087
  filler line 088
  filler line 089
  filler line 090
  filler line 091
  filler line 092
  filler line 093
  filler line 094
  filler line 095
  filler line 096
  filler line 097
  filler line 098
  filler line 099
==============================================================================*/

</style>
</head>
<body>

<!-- Top bar showing day/date -->
<div class="top-bar">
  <div id="dayDateBar" aria-live="polite"></div>
</div>

<!-- Main container -->
<div class="container" role="main" aria-label="منظم المهام">
  <h1>منظم المهام الذكي</h1>

  <div class="top-controls" role="toolbar" aria-label="أدوات">
    <button class="add-btn" onclick="openPrompt('task')">إضافة مهمة</button>
    <button class="add-channel-btn" onclick="openPrompt('channel')">إضافة قناة</button>
    <button class="delete-btn" onclick="openPrompt('reset')">إعادة ضبط الكل</button>
  </div>

  <!-- channels row: items will wrap to the next row after 3 per row on wide screens -->
  <div class="channels-row" id="channelsContainer" aria-live="polite"></div>
</div>

<!-- floating task preview (top-right) -->
<div id="floatingTask" draggable="true" aria-hidden="true">
  <span id="floatingTaskText"></span>
</div>

<!-- custom prompt -->
<div id="customPrompt" role="dialog" aria-modal="true" aria-hidden="true">
  <div id="promptText" style="font-weight:700; margin-bottom:8px;"></div>
  <input type="text" id="customPromptInput" aria-label="نص الإدخال" />
  <div style="margin-top:8px;">
    <button class="accept-btn" onclick="confirmPrompt()">موافق</button>
    <button class="cancel-btn" onclick="cancelPrompt()">إلغاء</button>
  </div>
</div>

<!-- custom error prompt -->
<div id="errorPrompt" role="alertdialog" aria-hidden="true" aria-live="assertive" style="display:none;">
  <p id="errorMsg" style="font-weight:700; margin:0 0 12px;"></p>
  <button id="errorOk" onclick="document.getElementById('errorPrompt').style.display='none'">موافق</button>
</div>

<script>
/* ========================================================================
   Smart Student Task Organizer — Script
   ======================================================================== */

/* stored structure:
   {
     order: ["مهم","غير مهم"],
     channels: {
       "مهم": [{text:"task", checked:false}, ...],
       ...
     }
   }
*/
let stored = JSON.parse(localStorage.getItem("tasksDataV2")) || {
  order: ["مهم", "غير مهم", "عاجل", "غير عاجل"],
  channels: { "مهم": [], "غير مهم": [], "عاجل": [], "غير عاجل": [] }
};

const container = document.getElementById("channelsContainer");
const floatingTask = document.getElementById("floatingTask");
const floatingTaskText = document.getElementById("floatingTaskText");
const promptInput = document.getElementById("customPromptInput");
const dayDateBar = document.getElementById("dayDateBar");
let draggedTaskData = null;
let promptType = "";
let currentChannelToEdit = "";

/* ----------------- helper: save to localStorage ----------------- */
function saveData(){
  try{
    localStorage.setItem("tasksDataV2", JSON.stringify(stored));
  }catch(e){
    console.warn("Failed to save localStorage:", e);
  }
}

/* ----------------- show custom error prompt ----------------- */
function showError(msg){
  const ep = document.getElementById("errorPrompt");
  const em = document.getElementById("errorMsg");
  ep.style.display = "block";
  em.textContent = msg;
  // focus OK for accessibility
  setTimeout(()=>document.getElementById("errorOk").focus(),50);
}

/* ----------------- date display ----------------- */
function updateDayDate(){
  const now = new Date();
  const days = ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
  const day = days[now.getDay()];
  const date = now.toLocaleDateString("ar-EG",{year:'numeric',month:'long',day:'numeric'});
  dayDateBar.textContent = `${day} - ${date}`;
}
updateDayDate();

/* ----------------- utility escaping ----------------- */
function escapeHtml(s){
  if(s === null || s === undefined) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

/* ----------------- render UI ----------------- */
/* When channels length >= 4 the 4th channel will simply wrap below due to flex-wrap rules */
function render(){
  container.innerHTML = "";
  stored.order.forEach(channel => {
    const tasks = stored.channels[channel] || [];
    const total = tasks.length;
    const completedCount = tasks.filter(t=>t.checked).length;
    const progressPercent = total? Math.round((completedCount/total)*100) : 0;

    const chDiv = document.createElement("div");
    chDiv.className = "channel" + (progressPercent===100? " completed": "");
    chDiv.innerHTML = `
      <div class="channel-header">
        <div class="channel-title">
          <span class="channel-name">${escapeHtml(channel)}</span>
          <span class="edit-icon" title="تعديل اسم القناة" onclick="editChannel('${escapeJs(channel)}')" tabindex="0" role="button" aria-label="تعديل">✏️</span>
        </div>
        <span class="delete-icon" onclick="deleteChannel('${escapeJs(channel)}')" role="button" tabindex="0" aria-label="حذف">✖</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${progressPercent}%"></div></div>
      <ul id="ul-${htmlSafeId(channel)}"></ul>
    `;
    container.appendChild(chDiv);

    const ul = document.getElementById(`ul-${htmlSafeId(channel)}`);
    (stored.channels[channel] || []).forEach(task => {
      const li = document.createElement("li");
      li.draggable = true;
      li.innerHTML = `
        <div class="task-content">
          <div class="task-check ${task.checked?'checked':''}" onclick="toggleCheck('${escapeJs(channel)}','${escapeJs(task.text)}')" role="checkbox" aria-checked="${task.checked}"></div>
          <span class="task-text">${escapeHtml(task.text)}</span>
        </div>
        <span class="delete-task" onclick="deleteTask('${escapeJs(channel)}','${escapeJs(task.text)}')" role="button" tabindex="0" aria-label="حذف المهمة">✖</span>
      `;
      li.addEventListener("dragstart", e=>{
        draggedTaskData = { text: task.text, fromChannel: channel, isNew:false };
      });
      ul.appendChild(li);
    });

    /* drag/drop handlers on channel card */
    chDiv.addEventListener("dragover", e=>{
      e.preventDefault();
      chDiv.classList.add("hovered");
    });
    chDiv.addEventListener("dragleave", e=>{
      chDiv.classList.remove("hovered");
    });
    chDiv.addEventListener("drop", e=>{
      e.preventDefault();
      chDiv.classList.remove("hovered");
      if(!draggedTaskData) return;
      const { text, fromChannel, isNew } = draggedTaskData;
      if(isNew){
        // add to this channel
        stored.channels[channel].push({ text, checked:false });
      } else {
        // move from old channel
        if(stored.channels[fromChannel]){
          stored.channels[fromChannel] = stored.channels[fromChannel].filter(t=>t.text !== text);
        }
        stored.channels[channel].push({ text, checked:false });
      }
      saveData();
      render();
      draggedTaskData = null;
      floatingTask.style.display = "none";
    });
  });

  // After render, ensure focus/ARIA etc if needed
}

/* ----------------- helpers to sanitize js-injected strings ----------------- */
function escapeJs(s){
  if(s === null || s === undefined) return "";
  return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"');
}
function htmlSafeId(s){
  return 'ch_'+String(s).replace(/[^\w\-]/g,'_');
}

/* ----------------- channel actions ----------------- */
function editChannel(channelName){
  currentChannelToEdit = channelName;
  openPrompt('editChannel');
}
function deleteChannel(name){
  // remove from data
  delete stored.channels[name];
  stored.order = stored.order.filter(ch => ch !== name);
  saveData();
  render();
}

/* ----------------- task actions ----------------- */
function toggleCheck(channel, taskText){
  const list = stored.channels[channel] || [];
  const t = list.find(x=>x.text === taskText);
  if(t) t.checked = !t.checked;
  saveData();
  render();
}
function deleteTask(channel, taskText){
  if(!stored.channels[channel]) return;
  stored.channels[channel] = stored.channels[channel].filter(x=>x.text !== taskText);
  saveData();
  render();
}

/* ----------------- Prompt logic ----------------- */
function openPrompt(type){
  promptType = type;
  const prompt = document.getElementById("customPrompt");
  prompt.style.display = "block";
  prompt.setAttribute("aria-hidden","false");
  promptInput.value = "";
  promptInput.style.display = (type === "reset") ? "none" : "block";

  if(type === "task"){
    document.getElementById("promptText").textContent = "أدخل اسم المهمة:";
  } else if(type === "channel"){
    document.getElementById("promptText").textContent = "أدخل اسم القناة:";
  } else if(type === "reset"){
    document.getElementById("promptText").textContent = "هل أنت متأكد أنك تريد إعادة ضبط الكل؟";
  } else if(type === "editChannel"){
    document.getElementById("promptText").textContent = "ما الذي تريد تغيير اسم القناة إليه؟";
    promptInput.value = currentChannelToEdit;
  }
  setTimeout(()=>promptInput.focus(),50);
}

function cancelPrompt(){
  const prompt = document.getElementById("customPrompt");
  prompt.style.display = "none";
  prompt.setAttribute("aria-hidden","true");
  currentChannelToEdit = "";
}

function confirmPrompt(){
  const inputVal = promptInput.value.trim();

  if(promptType === "task"){
    if(!inputVal){
      cancelPrompt();
      return;
    }
    // if no channels, show custom error
    if(!stored.order || stored.order.length === 0){
      showError("⚠️ لا يمكنك إضافة مهمة لأنه لا توجد قنوات.");
      cancelPrompt();
      return;
    }
    // show floating spawn (top-right)
    floatingTaskText.textContent = inputVal;
    floatingTask.style.display = "block";
    floatingTask.setAttribute("aria-hidden","false");
    draggedTaskData = { text: inputVal, fromChannel: null, isNew: true };
    cancelPrompt();
    return;
  } else if(promptType === "channel"){
    if(!inputVal){ cancelPrompt(); return; }
    if(stored.order.includes(inputVal)){
      showError("⚠️ يوجد قناة بنفس الاسم بالفعل.");
      return;
    }
    stored.order.push(inputVal);
    stored.channels[inputVal] = [];
    saveData();
    render();
    cancelPrompt();
    return;
  } else if(promptType === "reset"){
    // use custom prompt confirmation only (no confirm())
    // perform reset
    stored = {
      order: ["مهم", "غير مهم", "عاجل", "غير عاجل"],
      channels: { "مهم": [], "غير مهم": [], "عاجل": [], "غير عاجل": [] }
    };
    saveData();
    render();
    cancelPrompt();
    return;
  } else if(promptType === "editChannel"){
    if(!inputVal){ cancelPrompt(); return; }
    if(inputVal === currentChannelToEdit){ cancelPrompt(); return; }
    if(stored.order.includes(inputVal)){
      showError("⚠️ اسم القناة موجود مسبقًا. اختر اسمًا آخر.");
      return;
    }
    const oldName = currentChannelToEdit;
    const idx = stored.order.indexOf(oldName);
    if(idx !== -1) stored.order[idx] = inputVal;
    stored.channels[inputVal] = stored.channels[oldName] || [];
    delete stored.channels[oldName];
    saveData();
    render();
    cancelPrompt();
    return;
  }
}

/* ----------------- floating task drag behavior ----------------- */
floatingTask.addEventListener("dragstart", e=>{
  e.dataTransfer.setData("text/plain", "floating");
});
floatingTask.addEventListener("dragend", e=>{
  floatingTask.style.display = "none";
  draggedTaskData = null;
  floatingTask.setAttribute("aria-hidden","true");
});

/* pressing Enter in custom prompt */
promptInput.addEventListener("keydown", e=>{
  if(e.key === "Enter") confirmPrompt();
});

/* reposition pencils or any dynamic adjustments on resize */
window.addEventListener("resize", ()=>{
  // no special repositioning needed; flex-wrap handles layout
});

/* initial render */
render();


</script>

</body>
</html>

