<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منظم المهام الذكي</title>
<style>
  body {
    background: linear-gradient(145deg, #1a1a1a, #2c2c2c);
    color: #fff;
    font-family: "Tajawal", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
  }
  h1 {
    font-size: 2.4rem;
    margin-top: 20px;
    text-shadow: 0 0 10px #f00;
  }
  .container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 95vw;
    margin: 20px auto;
    gap: 12px;
  }
  .channel {
    background: rgba(40, 40, 40, 0.9);
    border-radius: 18px;
    width: 220px;
    padding: 12px;
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
    position: relative;
    transition: transform 0.2s;
  }
  .channel:hover {
    transform: translateY(-3px);
  }
  .channel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .channel-name {
    font-weight: bold;
    font-size: 1.2rem;
  }
  .delete-channel {
    color: red;
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    transition: transform 0.2s;
  }
  .delete-channel:hover {
    transform: scale(1.2);
  }
  .tasks {
    list-style: none;
    margin: 0;
    padding: 0;
    max-height: 250px;
    overflow-y: auto;
  }
  .task {
    background: #333;
    padding: 6px 8px;
    border-radius: 10px;
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    transition: background 0.2s;
  }
  .task:hover {
    background: #444;
  }
  .task.done .task-text {
    text-decoration: line-through;
    opacity: 0.6;
  }
  .task-text {
    flex: 1;
    margin-right: 6px;
    text-align: right;
  }
  .task-actions {
    display: flex;
    gap: 4px;
  }
  .task-actions button {
    background: transparent;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 16px;
    transition: transform 0.2s;
  }
  .task-actions button:hover {
    transform: scale(1.2);
  }
  .task-actions .edit-btn::before {
    content: "✎";
  }
  .task-actions .edit-btn:hover {
    transform: rotate(45deg);
  }
  .task-actions .delete-btn::before {
    content: "×";
    color: red;
    font-weight: bold;
  }
  .task-actions .check-btn::before {
    content: "✔";
    color: lime;
  }

  .add-task {
    display: flex;
    gap: 5px;
    margin-top: 8px;
  }
  .add-task input {
    flex: 1;
    border-radius: 8px;
    border: none;
    padding: 5px;
    outline: none;
    font-family: inherit;
  }
  .add-task button {
    background: red;
    border: none;
    color: #fff;
    border-radius: 8px;
    padding: 5px 10px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .add-task button:hover {
    background: #b00;
  }

  .floating-task {
    position: fixed;
    top: 10px;
    right: 10px;
    background: red;
    padding: 8px 15px;
    border-radius: 10px;
    color: white;
    font-weight: bold;
    cursor: grab;
    z-index: 1000;
    display: none;
  }

  .prompt-popup {
    background: #222;
    border-radius: 12px;
    padding: 15px;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    z-index: 2000;
    display: none;
  }
  .prompt-popup input {
    border-radius: 8px;
    border: none;
    padding: 6px;
    margin-bottom: 8px;
    width: 100%;
  }
  .prompt-popup button {
    background: red;
    border: none;
    border-radius: 8px;
    color: #fff;
    padding: 6px 10px;
    cursor: pointer;
    margin-left: 4px;
  }

  #resetAll {
    background: red;
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 8px 14px;
    cursor: pointer;
    margin-bottom: 12px;
  }
</style>
</head>
<body>
<h1>منظم المهام الذكي</h1>
<button id="resetAll">إعادة ضبط الكل</button>
<div class="container" id="channels"></div>

<div class="prompt-popup" id="promptPopup">
  <input id="promptInput" placeholder="اسم المهمة..." />
  <div style="text-align:center;">
    <button id="promptOk">موافق</button>
    <button id="promptCancel">إلغاء</button>
  </div>
</div>

<script>
const channelsContainer=document.getElementById("channels");
const popup=document.getElementById("promptPopup");
const popupInput=document.getElementById("promptInput");
const btnOk=document.getElementById("promptOk");
const btnCancel=document.getElementById("promptCancel");
let stored=JSON.parse(localStorage.getItem("taskData"))||{channels:{},order:[]};
let currentChannel=null;
let floatingTask=null;

function saveData(){
  localStorage.setItem("taskData",JSON.stringify(stored));
}

function render(){
  channelsContainer.innerHTML="";
  stored.order.forEach(ch=>{
    const channel=document.createElement("div");
    channel.className="channel";
    const head=document.createElement("div");
    head.className="channel-header";
    const name=document.createElement("span");
    name.className="channel-name";
    name.textContent=ch;
    const del=document.createElement("span");
    del.className="delete-channel";
    del.textContent="×";
    del.onclick=()=>deleteChannel(ch);
    head.append(name,del);
    channel.appendChild(head);

    const ul=document.createElement("ul");
    ul.className="tasks";
    ul.ondragover=e=>e.preventDefault();
    ul.ondrop=e=>onDrop(e,ch);
    stored.channels[ch].forEach(task=>{
      const li=document.createElement("li");
      li.className="task";
      if(task.checked)li.classList.add("done");
      li.draggable=true;
      li.ondragstart=e=>onDrag(e,ch,task.text);
      const text=document.createElement("span");
      text.className="task-text";
      text.textContent=task.text;
      const actions=document.createElement("div");
      actions.className="task-actions";

      const checkBtn=document.createElement("button");
      checkBtn.className="check-btn";
      checkBtn.onclick=()=>toggleCheck(ch,task.text);

      const editBtn=document.createElement("button");
      editBtn.className="edit-btn";
      editBtn.onclick=()=>editTaskPrompt(ch,task.text);

      const delBtn=document.createElement("button");
      delBtn.className="delete-btn";
      delBtn.onclick=()=>deleteTask(ch,task.text);

      actions.append(checkBtn,editBtn,delBtn);
      li.append(text,actions);
      ul.appendChild(li);
    });
    channel.appendChild(ul);
    const add=document.createElement("div");
    add.className="add-task";
    const input=document.createElement("input");
    input.placeholder="مهمة جديدة...";
    const btn=document.createElement("button");
    btn.textContent="+";
    btn.onclick=()=>addTask(ch,input);
    add.append(input,btn);
    channel.appendChild(add);
    channelsContainer.appendChild(channel);
  });
}
/* ---------------- Channel & Task Logic ---------------- */
function addChannel(){
  const name=prompt("اسم القناة:");
  if(!name||stored.channels[name])return;
  stored.channels[name]=[];
  stored.order.push(name);
  saveData();render();
}

function addTask(channel,input){
  const text=input.value.trim();
  if(!text)return;
  stored.channels[channel].push({text,checked:false});
  saveData();render();
  input.value="";
}

function deleteChannel(name){
  if(!confirm(`هل أنت متأكد من حذف القناة "${name}"؟`))return;
  delete stored.channels[name];
  stored.order=stored.order.filter(c=>c!==name);
  saveData();render();
}

function deleteTask(channel,text){
  stored.channels[channel]=stored.channels[channel].filter(t=>t.text!==text);
  saveData();render();
}

function toggleCheck(channel,text){
  const t=stored.channels[channel].find(x=>x.text===text);
  if(!t)return;
  t.checked=!t.checked;
  saveData();render();
}

function editTaskPrompt(channel,text){
  showPrompt("تعديل المهمة:",text,newText=>{
    if(!newText)return;
    const t=stored.channels[channel].find(x=>x.text===text);
    if(!t)return;
    t.text=newText.trim();
    saveData();render();
  });
}

/* ---------------- Prompt Popup ---------------- */
function showPrompt(title,defaultText,callback){
  popup.style.display="block";
  popupInput.value=defaultText||"";
  popupInput.focus();
  btnOk.onclick=()=>{
    popup.style.display="none";
    callback(popupInput.value.trim());
  };
  btnCancel.onclick=()=>{
    popup.style.display="none";
  };
  popupInput.onkeydown=e=>{
    if(e.key==="Enter"){
      btnOk.click();
    }
  };
}

/* ---------------- Reset Button ---------------- */
document.getElementById("resetAll").onclick=()=>{
  showPrompt("هل أنت متأكد من إعادة الضبط؟ اكتب 'نعم' للتأكيد.","",val=>{
    if(val==="نعم"){
      localStorage.clear();
      stored={channels:{},order:[]};
      render();
    }
  });
};

/* ---------------- Drag & Drop (Desktop) ---------------- */
function onDrag(ev,from,text){
  ev.dataTransfer.setData("text/plain",JSON.stringify({from,text}));
}
function onDrop(ev,to){
  ev.preventDefault();
  const data=JSON.parse(ev.dataTransfer.getData("text/plain"));
  if(!data)return;
  const {from,text}=data;
  if(from===to)return;
  const task=stored.channels[from].find(t=>t.text===text);
  if(!task)return;
  stored.channels[from]=stored.channels[from].filter(t=>t.text!==text);
  stored.channels[to].push(task);
  saveData();render();
}

/* ---------------- Floating Task Spawn (Desktop + Mobile) ---------------- */
function spawnFloatingTask(){
  if(floatingTask)return;
  floatingTask=document.createElement("div");
  floatingTask.className="floating-task";
  floatingTask.textContent="مهمة جديدة";
  document.body.appendChild(floatingTask);
  floatingTask.style.display="block";
  floatingTask.draggable=true;
  floatingTask.ondragstart=e=>{
    e.dataTransfer.setData("text/plain","newTask");
  };
  floatingTask.addEventListener("touchstart",onTouchStart,{passive:false});
}
/* ---------------- Floating Task Touch (Mobile) ---------------- */
let touchTask = null, touchOffsetX = 0, touchOffsetY = 0;

function onTouchStart(e) {
  if (!floatingTask) return;
  const t = e.touches[0];
  touchOffsetX = t.clientX - floatingTask.getBoundingClientRect().left;
  touchOffsetY = t.clientY - floatingTask.getBoundingClientRect().top;
  touchTask = true;
  e.preventDefault();
}

document.addEventListener("touchmove", e => {
  if (!touchTask || !floatingTask) return;
  const t = e.touches[0];
  floatingTask.style.left = (t.clientX - touchOffsetX) + "px";
  floatingTask.style.top = (t.clientY - touchOffsetY) + "px";
  e.preventDefault();
}, { passive: false });

document.addEventListener("touchend", e => {
  if (!touchTask) return;
  const t = e.changedTouches[0];
  const elem = document.elementFromPoint(t.clientX, t.clientY);
  const dropChannel = elem ? elem.closest(".channel") : null;
  if (dropChannel) {
    const name = dropChannel.querySelector(".channel-name").textContent.trim();
    stored.channels[name].push({ text: floatingTask.textContent.trim(), checked: false });
    saveData();
    render();
  }
  floatingTask.remove();
  floatingTask = null;
  touchTask = false;
});

/* ---------------- Pencil Rotation Fix ---------------- */
const style = document.createElement("style");
style.textContent = `
.edit-icon:hover {
  transform: rotate(45deg) scale(1.1);
}
.delete-icon {
  position: relative;
  width: 20px;
  height: 20px;
  display: inline-block;
}
.delete-icon::before,
.delete-icon::after {
  content: '';
  position: absolute;
  top: 9px;
  left: 3px;
  width: 14px;
  height: 2px;
  background-color: var(--danger);
  transition: background-color .2s;
}
.delete-icon::before { transform: rotate(45deg); }
.delete-icon::after { transform: rotate(-45deg); }
.delete-icon:hover::before,
.delete-icon:hover::after {
  background-color: #ff1a1a;
}
`;
document.head.appendChild(style);

/* ---------------- Reset Without Input ---------------- */
function openPrompt(type) {
  promptType = type;
  const p = document.getElementById("customPrompt");
  const txt = document.getElementById("promptText");
  if (type === 'reset') {
    if (confirm("هل أنت متأكد من أنك تريد إعادة ضبط كل المهام؟")) {
      localStorage.removeItem("tasksDataV2");
      location.reload();
    }
    return;
  }
  p.style.display = "block";
  promptInput.value = "";
  if (type === 'task') txt.textContent = "أدخل اسم المهمة:";
  else if (type === 'channel') txt.textContent = "أدخل اسم القناة:";
  else if (type === 'editChannel') {
    txt.textContent = "تغيير اسم القناة:";
    promptInput.value = currentChannelToEdit;
  }
  setTimeout(() => promptInput.focus(), 50);
}

/* ---------------- Enter Key = Confirm ---------------- */
promptInput.addEventListener("keypress", e => {
  if (e.key === "Enter") confirmPrompt();
});

/* ---------------- Initialize Everything ---------------- */
render();
document.addEventListener("DOMContentLoaded", () => {
  const spawnBtn = document.querySelector(".add-btn");
  spawnBtn.addEventListener("click", spawnFloatingTask);
});
</script>
</body>
</html>
