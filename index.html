<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>منظم المهام الذكي للطلاب</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#2e004f;--bg2:#4b0082;--bg3:#5a2a83;
  --accent-a:#00e5ff;--accent-b:#00bcd4;
  --success:#00ff66;--danger:#ff4d4d;
  --glass:rgba(255,255,255,0.08);--glass-strong:rgba(255,255,255,0.12);
  --prompt-bg:rgba(255,255,255,0.1);--text:#fff;
}
html,body{
  margin:0;padding:0;height:100%;
  font-family:'Tajawal',sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  background-size:400% 400%;animation:purpleGradient 20s ease infinite;
  color:var(--text);
}
@keyframes purpleGradient{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.top-bar{
  position:fixed;top:0;left:0;right:0;height:68px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,0.12);backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(255,255,255,0.08);
  z-index:1000;box-shadow:0 3px 14px rgba(0,0,0,0.35);
}
.container{
  width:95%;max-width:1400px;margin:92px auto 40px;
  background:rgba(255,255,255,0.06);border-radius:18px;padding:28px;
  box-shadow:0 18px 50px rgba(0,0,0,0.5);backdrop-filter:blur(10px);
}
h1{text-align:center;font-size:3rem;margin:0 0 18px;text-shadow:0 6px 18px rgba(0,0,0,0.5);}
.top-controls{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-bottom:22px;}
button{border:0;outline:0;padding:10px 18px;border-radius:12px;font-weight:700;cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.35);transition:transform .18s ease,box-shadow .18s ease;}
button:hover{transform:translateY(-2px) scale(1.02);}
button.add-btn{background:linear-gradient(45deg,var(--accent-a),var(--accent-b));color:#002;}
button.add-channel-btn{background:linear-gradient(45deg,#2e7d32,#43a047);color:#fff;}
button.delete-btn{background:linear-gradient(45deg,#ff4d4d,#ff1a1a);color:#fff;}
.channels-row{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;overflow-x:hidden;
  max-height:75vh;overflow-y:auto;padding:10px;}
.channel{
  background:var(--glass);border-radius:14px;padding:18px;min-width:260px;
  flex:1 1 calc(33.333% - 20px);box-sizing:border-box;
  box-shadow:0 12px 40px rgba(0,0,0,0.45);transition:.28s ease all;
  position:relative;
}
.channel.hovered{outline:3px dashed rgba(0,229,255,0.35);}
.channel.completed{background:rgba(0,255,102,0.08);}
@media(max-width:980px){.channel{flex:1 1 calc(50% - 18px);min-width:220px;}}
@media(max-width:560px){.channel{flex:1 1 100%;min-width:100%;}}
.channel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;}
.channel-title{display:flex;align-items:center;gap:8px;font-weight:700;font-size:1.1rem;}
.edit-icon{cursor:pointer;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;
  color:#fff;font-size:16px;border-radius:6px;transition:.2s;}
.edit-icon:hover{transform:rotate(45deg);background:rgba(255,255,255,0.06);}
.delete-icon{cursor:pointer;color:var(--danger);font-weight:800;font-size:1.3rem;}
.progress-bar{width:100%;height:10px;background:rgba(255,255,255,0.12);border-radius:6px;overflow:hidden;margin-bottom:14px;}
.progress-fill{height:100%;width:0%;border-radius:6px;background:linear-gradient(90deg,var(--accent-a),var(--accent-b));transition:width .36s ease;}
ul{list-style:none;margin:0;padding:0;min-height:60px;}
li{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0;padding:10px 12px;border-radius:10px;
  cursor:grab;background:rgba(255,255,255,0.06);transition:.16s;}
li:hover{transform:translateY(-3px) scale(1.01);background:rgba(255,255,255,0.09);}
.task-content{display:flex;align-items:center;gap:10px;flex:1;}
.task-check{width:22px;height:22px;border-radius:4px;border:2px solid var(--accent-a);cursor:pointer;position:relative;}
.task-check.checked{background:var(--accent-a);border-color:transparent;}
.task-check.checked::after{content:"✔";position:absolute;color:#fff;font-size:12px;left:3px;top:-3px;}
.delete-task{color:var(--danger);font-weight:800;font-size:1.2rem;cursor:pointer;}
#floatingTask{position:fixed;top:90px;right:20px;z-index:1200;background:rgba(255,255,255,0.06);padding:10px 14px;
  border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.5);cursor:grab;display:none;}
#customPrompt,#errorPrompt{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:var(--prompt-bg);backdrop-filter:blur(8px);padding:22px;border-radius:12px;z-index:2000;display:none;width:360px;text-align:center;}
#customPrompt input{width:100%;padding:10px;border-radius:8px;border:none;margin:12px 0;}
#customPrompt .accept-btn{background:#4caf50;color:#fff;}
#customPrompt .cancel-btn{background:#f44336;color:#fff;}
#errorPrompt button{margin-top:12px;padding:10px 18px;border-radius:8px;border:none;background:#fff;color:#000;font-weight:700;}
@media(max-width:640px){h1{font-size:2rem;}}
</style>
</head>
<body>
<div class="top-bar"><div id="dayDateBar"></div></div>
<div class="container">
  <h1>منظم المهام الذكي</h1>
  <div class="top-controls">
    <button class="add-btn" onclick="openPrompt('task')">إضافة مهمة</button>
    <button class="add-channel-btn" onclick="openPrompt('channel')">إضافة قناة</button>
    <button class="delete-btn" onclick="openPrompt('reset')">إعادة ضبط الكل</button>
  </div>
  <div class="channels-row" id="channelsContainer"></div>
</div>

<div id="floatingTask"><span id="floatingTaskText"></span></div>

<div id="customPrompt">
  <div id="promptText"></div>
  <input type="text" id="customPromptInput"/>
  <div id="promptButtons">
    <button class="accept-btn" onclick="confirmPrompt()">موافق</button>
    <button class="cancel-btn" onclick="cancelPrompt()">إلغاء</button>
  </div>
</div>

<div id="errorPrompt"><p id="errorMsg"></p><button onclick="this.parentElement.style.display='none'">موافق</button></div>

<script>
let stored=JSON.parse(localStorage.getItem("tasksDataV2"))||{order:["مهم","غير مهم","عاجل","غير عاجل"],channels:{"مهم":[],"غير مهم":[],"عاجل":[],"غير عاجل":[]}};
const container=document.getElementById("channelsContainer");
const floatingTask=document.getElementById("floatingTask");
const floatingTaskText=document.getElementById("floatingTaskText");
const promptInput=document.getElementById("customPromptInput");
let draggedTaskData=null,promptType="",touchStartX=0,touchStartY=0,dragging=false;
const isTouchDevice=('ontouchstart'in window)||(navigator.maxTouchPoints>0);

function saveData(){localStorage.setItem("tasksDataV2",JSON.stringify(stored));}
function escapeHtml(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function escapeJs(s){return String(s??"").replace(/\\/g,"\\\\").replace(/'/g,"\\'");}
function htmlSafeId(s){return'c_'+String(s).replace(/[^\w\-]/g,'_');}

function render(){
  container.innerHTML="";
  stored.order.forEach(channel=>{
    const tasks=stored.channels[channel]||[];
    const total=tasks.length,completed=tasks.filter(t=>t.checked).length;
    const percent=total?Math.round(completed/total*100):0;
    const chDiv=document.createElement("div");
    chDiv.className="channel"+(percent===100?" completed":"");
    chDiv.innerHTML=`
      <div class="channel-header">
        <div class="channel-title">
          <span class="channel-name">${escapeHtml(channel)}</span>
        </div>
        <span class="delete-icon" onclick="deleteChannel('${escapeJs(channel)}')">✖</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
      <ul id="ul-${htmlSafeId(channel)}"></ul>`;
    container.appendChild(chDiv);

    const ul=document.getElementById(`ul-${htmlSafeId(channel)}`);
    tasks.forEach(task=>{
      const li=document.createElement("li");
      li.draggable=!isTouchDevice;
      li.innerHTML=`
        <div class="task-content">
          <div class="task-check ${task.checked?'checked':''}" 
               onclick="toggleCheck('${escapeJs(channel)}','${escapeJs(task.text)}',event)"></div>
          <span class="task-text">${escapeHtml(task.text)}</span>
        </div>
        <span class="delete-task" onclick="deleteTask('${escapeJs(channel)}','${escapeJs(task.text)}')">✖</span>`;
      
      li.addEventListener("dragstart",()=>{draggedTaskData={text:task.text,fromChannel:channel};});
      
      if(isTouchDevice){
        // ✅ Prevent accidental drag when tapping the check button
        li.addEventListener("touchstart",e=>{
          if(e.target.closest('.task-check')){dragging=false;return;}
          const t=e.touches[0];
          touchStartX=t.clientX;touchStartY=t.clientY;dragging=true;
          draggedTaskData={text:task.text,fromChannel:channel};
          floatingTask.style.display="block";
          floatingTaskText.textContent=task.text;
          floatingTask.style.left=t.clientX+"px";
          floatingTask.style.top=t.clientY+"px";
        });

        li.addEventListener("touchmove",e=>{
          if(!dragging)return;
          const t=e.touches[0];
          floatingTask.style.left=t.clientX+"px";
          floatingTask.style.top=t.clientY+"px";
        });

        li.addEventListener("touchend",e=>{
          if(!dragging)return;
          dragging=false;
          floatingTask.style.display="none";
          const t=e.changedTouches[0];
          const el=document.elementFromPoint(t.clientX,t.clientY);
          const dropEl=el?el.closest(".channel"):null;
          if(dropEl){
            const target=dropEl.querySelector(".channel-name").textContent;
            stored.channels[draggedTaskData.fromChannel]=stored.channels[draggedTaskData.fromChannel].filter(x=>x.text!==draggedTaskData.text);
            stored.channels[target].push({text:draggedTaskData.text,checked:false});
            saveData();render();
          }
          draggedTaskData=null;
        });
      }

      ul.appendChild(li);
    });

    chDiv.addEventListener("dragover",e=>e.preventDefault());
    chDiv.addEventListener("drop",e=>{
      e.preventDefault();
      if(!draggedTaskData)return;
      const{name,text,fromChannel}=draggedTaskData;
      stored.channels[fromChannel]=stored.channels[fromChannel].filter(t=>t.text!==text);
      stored.channels[channel].push({text,checked:false});
      saveData();render();
      draggedTaskData=null;
      floatingTask.style.display="none";
    });
  });
}

function toggleCheck(ch,task,e){
  e.stopPropagation();
  const t=stored.channels[ch].find(x=>x.text===task);
  if(t)t.checked=!t.checked;
  saveData();render();
}
function deleteTask(ch,task){stored.channels[ch]=stored.channels[ch].filter(x=>x.text!==task);saveData();render();}
function deleteChannel(n){delete stored.channels[n];stored.order=stored.order.filter(c=>c!==n);saveData();render();}

function openPrompt(type){
  promptType=type;
  const p=document.getElementById("customPrompt");
  const txt=document.getElementById("promptText");
  const input=promptInput;
  const btns=document.getElementById("promptButtons");
  input.style.display="block";
  btns.innerHTML=`<button class="accept-btn" onclick="confirmPrompt()">موافق</button>
                  <button class="cancel-btn" onclick="cancelPrompt()">إلغاء</button>`;
  if(type==='task')txt.textContent="أدخل اسم المهمة:";
  else if(type==='channel')txt.textContent="أدخل اسم القناة:";
  else if(type==='reset'){
    txt.textContent="هل أنت متأكد أنك تريد إعادة ضبط الكل؟";
    input.style.display="none";
    btns.innerHTML=`<button class="accept-btn" onclick="confirmPrompt('yes')">نعم</button>
                    <button class="cancel-btn" onclick="cancelPrompt()">لا</button>`;
  }
  input.value="";
  p.style.display="block";
  if(type!=='reset')setTimeout(()=>input.focus(),50);
}

function cancelPrompt(){document.getElementById("customPrompt").style.display="none";}
function confirmPrompt(ans){
  const v=promptInput.value.trim();
  if(promptType==="task"){
    if(!v)return;
    const first=stored.order[0];
    stored.channels[first].push({text:v,checked:false});
    saveData();render();
  }else if(promptType==="channel"){
    if(!v)return;
    stored.order.push(v);
    stored.channels[v]=[];
    saveData();render();
  }else if(promptType==="reset"&&ans==="yes"){
    localStorage.removeItem("tasksDataV2");
    location.reload();
  }
  cancelPrompt();
}
promptInput.addEventListener("keydown",e=>{if(e.key==="Enter")confirmPrompt();});
render();
</script>
</body>
</html>
